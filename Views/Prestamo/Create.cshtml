@model List<Tenis3t.Models.DTOs.CrearPrestamoDto>
@{
    ViewData["Title"] = "Crear Varios Pr√©stamos";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Registrar varios pr√©stamos al mismo local</h2>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }

    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()

        <!-- üîπ Un solo usuario receptor -->
        <div class="form-group mb-4 position-relative">
            <label>Usuario Receptor</label>
            <input type="text" id="usuarioReceptorInput" class="form-control"
                placeholder="Escriba el nombre del usuario..." autocomplete="off" />
            <input type="hidden" name="usuarioReceptorId" id="usuarioReceptorId" />
            <div id="sugerenciasUsuarios" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
        </div>


        <div id="prestamosContainer"></div>

        <div class="mb-3 mt-4">
            <button type="button" class="btn btn-outline-primary" onclick="agregarPrestamo()">
                <i class="bi bi-plus-circle"></i> Agregar pr√©stamo
            </button>
        </div>

        <button type="submit" class="btn btn-success">
            <i class="bi bi-upload"></i> Guardar todos los pr√©stamos
        </button>
        <a asp-action="Index" class="btn btn-danger">Cancelar</a>
    </form>
</div>

@section Scripts {
    <script>
        let prestamoIndex = 0;

        function agregarPrestamo() {
            const container = document.getElementById("prestamosContainer");

            const card = document.createElement("div");
            card.classList.add("card", "mb-3", "p-3", "mt-5");
            card.innerHTML = `
                        <h5>Pr√©stamo #${prestamoIndex + 1}</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label>Producto</label>
                                <input type="text" class="form-control" id="productoInput-${prestamoIndex}" placeholder="Escriba producto..." autocomplete="off" />
                                <input type="hidden" name="prestamos[${prestamoIndex}].ProductoId" id="productoId-${prestamoIndex}" />
                                <div id="sugerencias-${prestamoIndex}" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                            </div>

                            <div class="col-md-3">
                                <label>Talla</label>
                                <select name="prestamos[${prestamoIndex}].TallaInventarioId" id="tallaSelect-${prestamoIndex}" class="form-select" disabled>
                                    <option value="">Seleccione talla</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label>Cantidad</label>
                                <input type="number" class="form-control" name="prestamos[${prestamoIndex}].Cantidad" id="cantidadInput-${prestamoIndex}" min="1" />
                                <small id="cantidadDisponible-${prestamoIndex}" class="text-muted"></small>
                            </div>

                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-danger w-100" onclick="this.closest('.card').remove()">Eliminar</button>
                            </div>
                        </div>
                    `;
            container.appendChild(card);

            configurarAutoComplete(prestamoIndex);
            prestamoIndex++;
        }

        function configurarAutoComplete(index) {
            let currentRequest = null;

            $(`#productoInput-${index}`).on('input', function () {
                var query = $(this).val();
                var sugerenciasDiv = $(`#sugerencias-${index}`);
                sugerenciasDiv.empty();

                if (query.length >= 2) {
                    if (currentRequest) currentRequest.abort();

                    currentRequest = $.get('/Prestamo/BuscarProductos', { termino: query }, function (data) {
                        sugerenciasDiv.empty();

                        if (data.length > 0) {
                            $.each(data, function (i, item) {
                                sugerenciasDiv.append(`
                                            <a href="#" class="list-group-item list-group-item-action"
                                               data-id="${item.id}" data-nombre="${item.nombre}">
                                               ${item.nombre}
                                            </a>
                                        `);
                            });
                        } else {
                            sugerenciasDiv.append('<div class="list-group-item text-muted">No se encontraron productos</div>');
                        }
                    }).always(() => currentRequest = null);
                }
            });

            $(`#sugerencias-${index}`).on('click', 'a', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                var nombre = $(this).data('nombre');

                $(`#productoInput-${index}`).val(nombre);
                $(`#productoId-${index}`).val(id);
                $(`#sugerencias-${index}`).empty();

                // Cargar tallas
                var tallaSelect = $(`#tallaSelect-${index}`);
                tallaSelect.empty().append('<option>Cargando...</option>');

                $.get('/Prestamo/GetTallasByProducto', { productoId: id }, function (data) {
                    tallaSelect.empty().append('<option value="">Seleccione talla</option>');
                    $.each(data, function (i, item) {
                        tallaSelect.append(`<option value="${item.id}">${item.talla} (${item.cantidad})</option>`);
                    });
                    tallaSelect.prop('disabled', false);
                });
            });

            // Mostrar cantidad disponible
            $(document).on('change', `#tallaSelect-${index}`, function () {
                var tallaId = $(this).val();
                if (tallaId) {
                    $.get('/Prestamo/GetCantidadDisponible', { tallaInventarioId: tallaId }, function (data) {
                        $(`#cantidadDisponible-${index}`).text(`Disponibles: ${data.cantidad}`);
                        $(`#cantidadInput-${index}`).attr('max', data.cantidad);
                    });
                }
            });
        }

        $(document).ready(function () {
            let currentUserRequest = null;

            $('#usuarioReceptorInput').on('input', function () {
                var query = $(this).val();
                var sugerenciasDiv = $('#sugerenciasUsuarios');
                sugerenciasDiv.empty();

                if (query.length >= 2) {
                    if (currentUserRequest) currentUserRequest.abort();

                    currentUserRequest = $.get('/Prestamo/BuscarUsuarios', { termino: query }, function (data) {
                        sugerenciasDiv.empty();

                        if (data.length > 0) {
                            $.each(data, function (i, item) {
                                sugerenciasDiv.append(`
                                <a href="#" class="list-group-item list-group-item-action"
                                   data-id="${item.id}" data-nombre="${item.userName}">
                                   ${item.userName}
                                </a>
                            `);
                            });
                        } else {
                            sugerenciasDiv.append('<div class="list-group-item text-muted">No se encontraron usuarios</div>');
                        }
                    }).always(() => currentUserRequest = null);
                }
            });

            $('#sugerenciasUsuarios').on('click', 'a', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                var nombre = $(this).data('nombre');

                $('#usuarioReceptorInput').val(nombre);
                $('#usuarioReceptorId').val(id);
                $('#sugerenciasUsuarios').empty();
            });
        });

    </script>
}