@model IEnumerable<Tenis3t.Models.IngresoViewModel>

@{
    ViewData["Title"] = "Historial de Ingresos";
}

<h2 class="mb-4 text-center">Historial de Ingresos al Inventario</h2>

<div class="accordion mx-auto" id="ingresosAccordion" style="max-width: 1000px;">
    @foreach (var ingreso in Model)
    {
        var loteDisplay = !string.IsNullOrEmpty(ingreso.LoteIngreso)
        ? (ingreso.LoteIngreso.Length >= 8 ? ingreso.LoteIngreso.Substring(0, 8) : ingreso.LoteIngreso)
        : "Sin Lote";

        <div class="accordion-item mb-3 border rounded">
            <h2 class="accordion-header" id="heading-@ingreso.LoteIngreso">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-@ingreso.LoteIngreso" aria-expanded="false"
                    aria-controls="collapse-@ingreso.LoteIngreso" style="background-color: #ede8f9; color: #4a148c;">
                    <div class="d-flex justify-content-between w-100">
                        <span class="fw-bold">Ingreso: @loteDisplay</span>
                        <span class="text-muted">Fecha: @ingreso.FechaIngreso.ToString("dd/MM/yyyy HH:mm")</span>
                        <span class="badge bg-primary">Productos: @ingreso.CantidadProductos</span>
                    </div>
                </button>
            </h2>
            <div id="collapse-@ingreso.LoteIngreso" class="accordion-collapse collapse"
                aria-labelledby="heading-@ingreso.LoteIngreso" data-bs-parent="#ingresosAccordion">
                <div class="accordion-body">
                    <table class="table table-bordered table-striped table-sm">
                        <thead class="table-light">
                            <tr class="text-center">
                                <th>Nombre</th>
                                <th>Género</th>
                                <th>Costo</th>
                                <th>Precio Venta</th>
                                <th>Tallas</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in ingreso.Productos)
                            {
                                <tr class="align-middle text-center">
                                    <td>@p.Nombre</td>
                                    <td>@(p.Genero?.ToLower() == "hombre" ? "Hombre" : "Dama")</td>
                                    <td>$@p.Costo</td>
                                    <td>$@p.PrecioVenta</td>
                                    <td>
                                        @if (p.Tallas != null && p.Tallas.Any())
                                        {
                                            foreach (var t in p.Tallas)
                                            {
                                                <span class="badge bg-danger me-1">T@(@t.Talla): @t.Cantidad</span>
                                            }
                                        }
                                        else
                                        {
                                            <em>Sin tallas registradas</em>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div class="text-end mt-3">
                        <button class="btn btn-outline-primary" onclick="imprimirIngreso('@ingreso.LoteIngreso')">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script>
    function imprimirIngreso(lote) {
        // Tomar el contenido de la tabla de ese lote
        const contenido = document.querySelector(`#collapse-${lote} .accordion-body`).innerHTML;

        // Recortar el ID largo para mostrar solo una parte representativa
        const loteDisplay = lote && lote.length >= 8 ? lote.substring(0, 8).toUpperCase() : lote;

        // Obtener la fecha actual con formato legible
        const fechaActual = new Date().toLocaleString("es-CO", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });

        // Nombre del local (puedes personalizarlo fácilmente)
        const nombreLocal = "INGRESO INVENTARIO";

        // Crear ventana nueva para impresión
        const ventana = window.open('', '_blank');

        ventana.document.write(`
            <html>
                <head>
                    <title>Ingreso de Lote ${loteDisplay}</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
                    <style>
                        body {
                            font-family: 'Segoe UI', Arial, sans-serif;
                            padding: 40px;
                            color: #333;
                        }
                        header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #4a148c;
                            padding-bottom: 10px;
                        }
                        h1 {
                            font-size: 1.8rem;
                            color: #4a148c;
                            margin-bottom: 5px;
                        }
                        h2 {
                            font-size: 1.2rem;
                            color: #666;
                            margin-bottom: 0;
                        }
                        .info {
                            margin-top: 10px;
                            text-align: center;
                            font-size: 0.9rem;
                            color: #555;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: center;
                            font-size: 0.95rem;
                        }
                        th {
                            background-color: #f3f0ff;
                            color: #4a148c;
                            font-weight: 600;
                        }
                        .badge {
                            margin-right: 4px;
                            font-size: 0.8rem;
                        }
                        footer {
                            margin-top: 40px;
                            text-align: right;
                            font-size: 0.85rem;
                            color: #666;
                            border-top: 1px solid #ccc;
                            padding-top: 10px;
                        }
                        media print {
                            button {
                                display: none;
                            }
                        }
                    </style>
                </head>
                <body>
                    <header>
                        <h1>${nombreLocal}</h1>
                        <h2>Registro de Ingreso de Lote</h2>
                        <div class="info">
                            <strong>ID de Lote:</strong> ${loteDisplay} <br>
                            <strong>Fecha de impresión:</strong> ${fechaActual}
                        </div>
                    </header>

                    ${contenido}

                    <footer>
                        <p>NOTA: Revisar bien y cualquier novedad comunicarse con su superior</p>
                    </footer>
                </body>
            </html>
        `);

        ventana.document.close();
        ventana.print();
    }
</script>
