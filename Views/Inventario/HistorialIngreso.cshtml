@model IEnumerable<Tenis3t.Models.IngresoViewModel>

@{
    ViewData["Title"] = "Historial de Ingresos";
}

<h2 class="mb-4 text-center">Historial de Ingresos al Inventario</h2>

<div class="accordion mx-auto" id="ingresosAccordion" style="max-width: 1000px;">
    @foreach (var ingreso in Model)
    {
        var loteDisplay = !string.IsNullOrEmpty(ingreso.LoteIngreso)
        ? (ingreso.LoteIngreso.Length >= 8 ? ingreso.LoteIngreso.Substring(0, 8) : ingreso.LoteIngreso)
        : "Sin Lote";

        <div class="accordion-item mb-3 border rounded">
            <h2 class="accordion-header" id="heading-@ingreso.LoteIngreso">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-@ingreso.LoteIngreso" aria-expanded="false"
                    aria-controls="collapse-@ingreso.LoteIngreso" style="background-color: #ede8f9; color: #4a148c;">
                    <div class="d-flex justify-content-between w-100">
                        <span class="fw-bold">Ingreso: @loteDisplay</span>
                        <span class="text-muted">Fecha: @ingreso.FechaIngreso.ToString("dd/MM/yyyy HH:mm")</span>
                        <span class="badge bg-primary">Productos: @ingreso.CantidadProductos</span>
                    </div>
                </button>
            </h2>
            <div id="collapse-@ingreso.LoteIngreso" class="accordion-collapse collapse"
                aria-labelledby="heading-@ingreso.LoteIngreso" data-bs-parent="#ingresosAccordion">
                <div class="accordion-body">
                    <table class="table table-bordered table-striped table-sm">
                        <thead class="table-light">
                            <tr class="text-center">
                                <th>Nombre</th>
                                <th>GÃ©nero</th>
                                <th>Costo</th>
                                <th>Precio Venta</th>
                                <th>Tallas</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in ingreso.Productos)
                            {
                                <tr class="align-middle text-center">
                                    <td>@p.Nombre</td>
                                    <td>@(p.Genero?.ToLower() == "hombre" ? "Hombre" : "Dama")</td>
                                    <td>$@p.Costo</td>
                                    <td>$@p.PrecioVenta</td>
                                    <td>
                                        @if (p.Tallas != null && p.Tallas.Any())
                                        {
                                            foreach (var t in p.Tallas)
                                            {
                                                <span class="badge bg-danger me-1">T@(@t.Talla): @t.Cantidad</span>
                                            }
                                        }
                                        else
                                        {
                                            <em>Sin tallas registradas</em>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div class="text-end mt-3">
                        <button class="btn btn-outline-primary" onclick="imprimirIngreso('@ingreso.LoteIngreso')">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script>
    function imprimirIngreso(lote) {
        const contenido = document.querySelector(`#collapse-${lote} .accordion-body`).innerHTML;
        const ventana = window.open('', '_blank');
        ventana.document.write(`
            <html>
                <head>
                    <title>Ingreso ${lote}</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
                    <style>
                        body { font-family: Arial, sans-serif; padding: 30px; }
                        h3 { text-align: center; margin-bottom: 20px; color: #4a148c; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .badge { margin-right: 4px; }
                    </style>
                </head>
                <body>
                    <h3>Ingreso ${lote}</h3>
                    ${contenido}
                </body>
            </html>
        `);
        ventana.document.close();
        ventana.print();
    }
</script>